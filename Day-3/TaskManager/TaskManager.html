<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Task Manager</title>
	<style>
	.completed {
		color : red;
		text-decoration: line-through;
		font-style : italic;
	}
	</style>
	<script src="jquery.js"></script>
	<script type="text/template" id="TaskManagerTemplate">
		<h1>Task Manager</h1>
		<hr>
		<span>Task :</span>
		<input type="text" name="" id="txtTask">
		<input type="button" value="Add Task" id="btnAddTask">
		<input type="button" value="Remove Completed" id="btnRemoveCompleted">
		<ul id="ulTaskList"></ul>
	</script>
	<script>
	function TaskManagerModel(){
		this.list = [];
		this.addTask = function(taskName){
			var newTask = new TaskModel(taskName);
			this.list.push(newTask);
			this.triggerChange("add",newTask);
		}
		var onChangeCallbacks = {};
		this.addOnChange = function(attrName,callback){
			if (typeof onChangeCallbacks[attrName] === "undefined")
				onChangeCallbacks[attrName] = [];
			onChangeCallbacks[attrName].push(callback);				
		};

		this.triggerChange = function(attrName){
			var callbacks = onChangeCallbacks[attrName] || [];
			var that = this;
			for(var i=0;i<callbacks.length;i++){
				var callback = callbacks[i];

				setTimeout((function(index,args){
					 return function(){
   						callbacks[index].apply(that,Array.prototype.slice.call(args,1));
					 }
				})(i,arguments));
			}
		}
	}
	function TaskManagerView(model){
		this.$root = $("<div>");
		var _templateId = "#TaskManagerTemplate",
			_model = model,
			that = this;

		this.init = function(){
			//Model Events
			_model.addOnChange("add",function(task){
				var newTaskView = new TaskView(task);
				newTaskView.init();
				newTaskView.render().$root.appendTo(that.$root.find("#ulTaskList"));
			});

			//View Events
			this.$root.on("click","#btnAddTask", function(){
				_model.addTask($("#txtTask",that.$root).val())
			});
		};

		this.render = function(){
			this.$root.append($(_templateId).html());
			return this;
		}

	}

	function TaskModel(taskName){
		var onChangeCallbacks = {};
		this.addOnChange = function(attrName,callback){
			if (typeof onChangeCallbacks[attrName] === "undefined")
				onChangeCallbacks[attrName] = [];
			onChangeCallbacks[attrName].push(callback);				
		};

		this.triggerChange = function(attrName){
			var callbacks = onChangeCallbacks[attrName] || [];
			var that = this;
			for(var i=0;i<callbacks.length;i++){
				var callback = callbacks[i];

				setTimeout((function(index,args){
					 return function(){
   						callbacks[index].apply(that,Array.prototype.slice.call(args,1));
					 }
				})(i,arguments));
			}
		}

		var _taskName = taskName,
			_isCompleted = false;
		this.taskName = function(val){
			if (typeof val === "undefined") return _taskName;
			_taskName = val;
			this.triggerChange("taskName", _taskName);
		};
		this.isCompleted = function(){
			return _isCompleted;
		};
		this.toggleCompletion = function(){
			_isCompleted = !_isCompleted;
			this.triggerChange("isCompleted",_isCompleted);
		}
	}

	function TaskView(model){
		var _model = model;
		this.$root = $("<li>");
		var that = this;
		this.init = function(){
			//Model Events
			_model.addOnChange("taskName", function(taskName){
				that.$root.html(taskName)
			});
			_model.addOnChange("isCompleted", function(isCompleted){
				if (isCompleted){
					that.$root.addClass("completed");
				} else {
					that.$root.removeClass("completed");
				}
			});

			//View Events
			this.$root.click(function(){
				_model.toggleCompletion();
			});
		};
		this.render = function(){
			this.$root.html(_model.taskName()).addClass(_model.isCompleted() ? "completed" : "");
			return this;
		}
	}

	$(function(){
		window.taskManagerModel = new TaskManagerModel();
		window.view1 = new TaskManagerView(taskManagerModel);
		view1.init();
		view1.render().$root.appendTo(document.body);
	});
	</script>
</head>
<body>
	
</body>
</html>